name: "Home-CI External Test Results Processing"

on:
  repository_dispatch:
    types: [dispatch-with-artifacts, test-dispatch-with-artifacts]

jobs:
  process-test-results:
    runs-on: ubuntu-latest
    steps:
    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Display test metadata
      run: |
        echo "ðŸ” Processing test results from home-ci"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“ Branch: ${{ github.event.client_payload.branch }}"
        echo "ðŸ“ Commit: ${{ github.event.client_payload.commit }}"
        echo "ðŸ“ Success: ${{ github.event.client_payload.success }}"
        echo "ðŸ“ Source: ${{ github.event.client_payload.source }}"
        echo "ðŸ“ Timestamp: ${{ github.event.client_payload.timestamp }}"
        echo "ðŸ“ Artifact: ${{ github.event.client_payload.artifact_name }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Process test logs
      run: |
        echo "ðŸ“‹ Processing test execution logs..."

        # Check if artifacts exist and process them
        if [ "${{ toJson(github.event.client_payload.artifacts) }}" != "null" ]; then
          echo "âœ… Test artifacts found"

          # Create artifacts directory
          mkdir -p test-artifacts

          # List available artifacts
          echo "ðŸ“¦ Available artifacts:"
          echo '${{ toJson(github.event.client_payload.artifacts) }}' | jq -r 'keys[]' | while read artifact; do
            echo "  - $artifact"
          done

        else
          echo "âš ï¸  No artifacts found in payload"
        fi

    - name: Process e2e test report
      if: github.event.client_payload.artifacts
      run: |
        echo "ðŸ“Š Processing e2e test report..."

        # Extract YAML e2e report files
        echo '${{ toJson(github.event.client_payload.artifacts) }}' | jq -r '
          to_entries[] |
          select(.key | endswith("-e2e-report.yaml")) |
          "REPORT_FILE=\(.key)\nREPORT_CONTENT=\(.value.content)"
        ' > report_vars.env

        if [ -f report_vars.env ] && [ -s report_vars.env ]; then
          source report_vars.env

          # Decode and save e2e report content
          if [ ! -z "$REPORT_CONTENT" ] && [ "$REPORT_CONTENT" != "null" ]; then
            echo "$REPORT_CONTENT" | base64 -d > "test-artifacts/$REPORT_FILE"
            echo "âœ… Saved e2e report: test-artifacts/$REPORT_FILE"

            # Parse and display e2e report information
            echo ""
            echo "ðŸ§ª E2E Test Report Summary:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Extract general info using yq (if available) or basic grep/awk
            if command -v yq >/dev/null 2>&1; then
              echo "ðŸ“ Test Run Info:"
              echo "  Start time: $(yq e '.test_run.start_time' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Runner: $(yq e '.test_run.runner' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  OS: $(yq e '.environment.os' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Architecture: $(yq e '.environment.arch' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"

              echo ""
              echo "ðŸ Test Summary:"
              echo "  End time: $(yq e '.summary.end_time' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Duration: $(yq e '.summary.duration_seconds' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A') seconds"
              echo "  Overall status: $(yq e '.summary.overall_status' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Success rate: $(yq e '.summary.success_rate' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Total steps: $(yq e '.summary.total_steps' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Passed steps: $(yq e '.summary.passed_steps' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"
              echo "  Failed steps: $(yq e '.summary.failed_steps' test-artifacts/$REPORT_FILE 2>/dev/null || echo 'N/A')"

              echo ""
              echo "ðŸ“‹ Test Steps:"
              yq e '.steps[] | "  " + .phase + ": " + .status + " (" + .timestamp + ")"' test-artifacts/$REPORT_FILE 2>/dev/null || echo "  Unable to parse steps"
            else
              echo "âš ï¸  yq not available, showing raw summary info"
              grep -A 10 "summary:" test-artifacts/$REPORT_FILE || echo "  Unable to extract summary"
            fi

          else
            echo "âš ï¸  E2E report content is empty or null"
          fi
        else
          echo "â„¹ï¸  No e2e report files found in artifacts"
        fi

    - name: Decode and save test logs
      if: github.event.client_payload.artifacts
      run: |
        echo "ðŸ’¾ Extracting test logs..."

        # Extract log files (find files with .log extension in artifacts)
        echo '${{ toJson(github.event.client_payload.artifacts) }}' | jq -r '
          to_entries[] |
          select(.key | endswith(".log")) |
          "LOG_FILE=\(.key)\nLOG_CONTENT=\(.value.content)"
        ' > log_vars.env

        if [ -f log_vars.env ] && [ -s log_vars.env ]; then
          source log_vars.env

          # Decode and save log content
          if [ ! -z "$LOG_CONTENT" ] && [ "$LOG_CONTENT" != "null" ]; then
            echo "$LOG_CONTENT" | base64 -d > "test-artifacts/$LOG_FILE"
            echo "âœ… Saved log file: test-artifacts/$LOG_FILE"

            # Show log summary
            echo ""
            echo "ðŸ“Š Log file summary:"
            echo "  Size: $(wc -c < test-artifacts/$LOG_FILE) bytes"
            echo "  Lines: $(wc -l < test-artifacts/$LOG_FILE) lines"

          else
            echo "âš ï¸  Log content is empty or null"
          fi
        else
          echo "â„¹ï¸  No log files found in artifacts"
        fi

    - name: Create test result summary
      run: |
        echo "ðŸ“ˆ Creating test result summary..."

        # Determine status emoji and message
        if [ "${{ github.event.client_payload.success }}" == "true" ]; then
          STATUS_EMOJI="âœ…"
          STATUS_MSG="SUCCESS"
          STATUS_COLOR="ðŸŸ¢"
        else
          STATUS_EMOJI="âŒ"
          STATUS_MSG="FAILURE"
          STATUS_COLOR="ðŸ”´"
        fi

        echo ""
        echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
        echo "â”‚           TEST RESULT SUMMARY           â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚ Status: $STATUS_COLOR $STATUS_EMOJI $STATUS_MSG"
        echo "â”‚ Branch: ${{ github.event.client_payload.branch }}"
        echo "â”‚ Commit: ${{ github.event.client_payload.commit }}"
        echo "â”‚ Source: ${{ github.event.client_payload.source }}"
        echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"

        # Create summary for GitHub Actions summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## $STATUS_EMOJI External Test Results - $STATUS_MSG

        **Test Details:**
        - **Status**: $STATUS_EMOJI $STATUS_MSG
        - **Branch**: \`${{ github.event.client_payload.branch }}\`
        - **Commit**: \`${{ github.event.client_payload.commit }}\`
        - **Source**: ${{ github.event.client_payload.source }}
        - **Timestamp**: $(date -d @${{ github.event.client_payload.timestamp }} 2>/dev/null || echo "${{ github.event.client_payload.timestamp }}")

        **Artifact**: ${{ github.event.client_payload.artifact_name }}
        EOF

    - name: Upload artifacts
      if: github.event.client_payload.artifacts
      uses: actions/upload-artifact@v4
      with:
        name: external-test-results-${{ github.event.client_payload.artifact_name }}
        path: test-artifacts/
        retention-days: 30
