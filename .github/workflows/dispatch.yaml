name: "Home-CI External Test Results Processing"

on:
  repository_dispatch:
    types: [dispatch-with-artifacts]

jobs:
  process-test-results:
    runs-on: ubuntu-latest
    steps:
      - name: Initialize
        run: mkdir -p test-artifacts

      - name: Extract and Decode Artifacts
        run: |
          echo "üì¶ Extracting artifacts..."
          echo '${{ toJson(github.event.client_payload.artifacts) }}' | jq -r 'to_entries[] | "\(.key) \(.value.content)"' | while read -r filename content; do
            if [ "$content" != "null" ]; then
              echo "$content" | base64 -d > "test-artifacts/$filename"
              echo "‚úÖ Decoded: $filename"
            fi
          done

      - name: Generate Summary Metadata
        if: always()
        run: |
          SUCCESS="${{ github.event.client_payload.success }}"
          [ "$SUCCESS" == "true" ] && EMOJI="‚úÖ" || EMOJI="‚ùå"
          [ "$SUCCESS" == "true" ] && STATUS="SUCCESS" || STATUS="FAILURE"

          {
            echo "## $EMOJI External Test Results: $STATUS"
            echo ""
            echo "### üìç Execution Details"
            echo "| Property | Value |"
            echo "| :--- | :--- |"
            echo "| **Source** | ${{ github.event.client_payload.source }} |"
            echo "| **Branch** | \`${{ github.event.client_payload.branch }}\` |"
            echo "| **Commit** | \`${{ github.event.client_payload.commit }}\` |"
            echo "| **Artifact Name** | ${{ github.event.client_payload.artifact_name }} |"
          } >> $GITHUB_STEP_SUMMARY

      - name: Parse E2E Report
        if: always()
        shell: python
        run: |
          import yaml
          import os

          report_path = "test-artifacts/e2e-report.yaml"
          summary_path = os.environ['GITHUB_STEP_SUMMARY']

          if os.path.exists(report_path):
              with open(summary_path, "a") as summary:
                  summary.write("### üìä Test Metrics\n")
                  try:
                      with open(report_path, "r") as f:
                          data = yaml.safe_load(f)
                          s = data.get("summary", {})
                          summary.write(f"- **Overall Status**: {s.get('overall_status', 'N/A')}\n")
                          summary.write(f"- **Success Rate**: {s.get('success_rate', 'N/A')}\n")
                          summary.write(f"- **Duration**: {s.get('duration_seconds', 0)}s\n")
                          summary.write("\n#### üìã Detailed Steps\n")
                          for step in data.get("steps", []):
                              summary.write(f"- **{step['phase']}**: {step['status']} _({step['timestamp']})_\n")
                  except Exception as e:
                      summary.write(f"‚ö†Ô∏è Error parsing report: {e}\n")
          else:
              with open(summary_path, "a") as summary:
                  summary.write("‚ö†Ô∏è No `e2e-report.yaml` found.\n")

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: external-results-${{ github.event.client_payload.artifact_name }}
          path: test-artifacts/
          retention-days: 30

      - name: Final Result Logic
        run: |
          if [ "${{ github.event.client_payload.success }}" != "true" ]; then
            exit 1
          fi
